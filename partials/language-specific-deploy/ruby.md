## Configure your Ruby on Rails application
### Mandatory configuration

Be sure that:

* you push to the <strong>master branch</strong>
* you commit your `gems.locked` or `Gemfile.lock` file
* you have a `config.ru` file (this one is most of the time generated by rails)
* you have `gem puma` in your `Gemfile` (`puma` is the default application server from rails, when creating a new ruby application, an [environment variable](#setting-up-environment-variables-on-clever-cloud) is automatically added: `CC_RACKUP_SERVER=puma`)

You need to provide a `gems.locked` or `Gemfile.lock` file. To do that ensure you have at least once run `bundle install` in your terminal at the root of your rails project.

### Choose ruby version

If you specify a ruby version in your `gems.rb` of `Gemfile`, we'll use it, otherwise; keep reading.

On your Clever Cloud application create an [environment variable](#setting-up-environment-variables-on-clever-cloud) `CC_RUBY_VERSION=rubyversion` where `rubyversion` represents:

 * "2" will select the greatest "2.X.Y" version available.
 * "2.5" will select the greatest "2.5.Y" version available.
 * "2.5.3" will select the "2.5.3" version.

Due to current landscape in ruby applications, the default version is the greatest 2.5.Y. We provide also the 2.4.Y and 2.3.Y version.

If given `rubyversion` does not match any available version, your deployment will fail.

### Choose your environment

You can set the `RUBY_ENV` [environment variable](#setting-up-environment-variables-on-clever-cloud) to the value you want. By default it is set to `production`.
Most used values are `production` and `development` but you can use any custom one as long as you have setted up of the required variables for this environment in your `./config/` folder files.

### Secure configuration of secret key

There are many way to add secret key to your env and each one is valid. Clever Cloud provides you a secure way so you don't have to commit any file containing it.

1. generate the secret key locally with `rake secret`
2. add it to your environment in `./config/secret.yml` with:
```
production:
    secret_key_base: <%= ENV["SECRET_KEY_BASE"] %>
```

### Optional env and rake goals configuration with clevercloud/ruby.json

You can configure your deployment via the `./clevercloud/ruby.json` file using the following syntax:

```javascript
{
  "deploy" : {
    "env": "<string>",
    "rakegoals": [<string>],
    "sidekiq": true
  }
}
```

The following table describes each field:

<table id="nodedeps" class="table table-bordered table-striped">
<thead>
<tr>
<th>Usage</th>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="label label-default">Optional</span></td>
<td>deploy.env</td>
<td>This field is only used for overriding the default "production" RAILS_ENV value.</td>
</tr>
<tr>
<td><span class="label label-default">Optional</span></td>
<td>deploy.rakegoals</td>
<td>
Specify a list of rake goals to execute.
They will be executed in the order of the list:<br />
<pre>bundle exec rake "goal1"</pre><br />
<pre>bundle exec rake "goal2"</pre>&hellip;<br />
We <strong>do not</strong> execute any rake goals by default.
</td>
</tr>
<tr>
<td><span class="label label-default">Optional</span></td>
<td>deploy.sidekiq</td>
<td>
Run a sidekiq process in background. Please note you will need a redis instance to use this
feature.
</td>
</tr>
</tbody>
</table>

#### Sidekiq specific configuration 

The sidekiq field can also be an array of strings instead of a boolean, like this:

```javascript
"sidekiq":  [
   "./config/sidekiq_1.yml",
   "./config/sidekiq_2.yml",
   "./config/sidekiq_3.yml"
]
```

Each string is the path *from the root of the repository* to a sidekiq configuration file.
Each file might contain something like this standard sidekiq.yml file:

```yaml
---
:concurrency: 4
:pidfile:     tmp/pids/sidekiq_1.pid
:queues:
  - [critical, 2]
  - default

production:
  :logfile: ./log/sidekiq.log
---
```

### Manage your static files and assets

Static files are configured with [environment variables](#setting-up-environment-variables-on-clever-cloud)s:

`STATIC_FILES_PATH`: should point to a directory where your static files are stored.

`STATIC_URL_PREFIX`: the URL path under which you want to serve static files (e.g. `/public/`)

**Note**: the path of your folder must be absolute regarding the root of your application.

**Note**: setting the `STATIC_URL_PREFIX` to `/` will make the deployment to fail.

If you use the asset pipeline, make sure to include the `assets:precompile` task in the `rakegoals` field of `clevercloud/ruby.json`.

```json
{
    "deploy": {
        "rakegoals": ["db:migrate", "assets:precompile"]
    }
}
```

**Note**: if your project uses `webpacker`, make sure to enable the dedicated build instance option in the **Information** menu of your application in the Clever Cloud console because `webpacker` needs a lot a ressources when starting.

### Using Active Storage and Cellar S3

Only for Rails >= 5.2.

- Enable Active Storage for your application: `$ rails active_storage:install` then `$ rake db:migrate`
- Add `gem "aws-sdk-s3", require: false` to your Gemfile, run `$ bundle install`
- Add `config.active_storage.service = :clevercloud` in `config/environments/production.yml`
- Add in `config/storage.yml`:
```
clevercloud:
  service: S3
  access_key_id: <%= ENV['CELLAR_ADDON_KEY_ID'] %>
  secret_access_key: <%= ENV['CELLAR_ADDON_KEY_SECRET'] %>
  region: us-east-1
  bucket: <%= ENV['CELLAR_ADDON_BUCKET_NAME'] %>
  endpoint: <%= ENV['CELLAR_ADDON_ENDPOINT'] %>
  force_path_style: true
```
- In the clever cloud console create a Cellar S3 storage add-on, name it, link it to your rails application and create a bucket.
- In the environment variables section of your Ruby on Rails application on Clever Cloud add the following environment variables:
```
CELLAR_ADDON_BUCKET_NAME=<your bucket name>
CELLAR_ADDON_ENDPOINT=https://cellar-c2.services.clever-cloud.com
```

You can now commit and push your changes.

Also, you are able to use a Filesystem Bucket to store your static files. Please refer to the
[File System Buckets]({{< ref "deploy/addon/fs-bucket.md" >}}) section.

### nginx configuration

nginx settings can be configured with [environment variables](#setting-up-environment-variables-on-clever-cloud):

 - `NGINX_READ_TIMEOUT`: the response timeout in seconds. (Defaut: 300)

Nginx settings can be configured further in `clevercloud/http.json`. All its fields are optional.

 - `languages`: configure a default language and redirections
 - `error_pages`: configure custom files for error pages
 - `force_https`: automatically redirect HTTP traffic to HTTPS
 - `aliases`: set up redirections
 - `charset`: force a specific charset

```json
{
    "languages": {
        "default": {"rewrite": "en"},
        "fr": {"rewrite": "en"}
    },
    "error_pages": {
        "404": "path/to/page"
    },
    "force_https": true,
    "aliases": {
        "/path":Â "redirection"
    },
    "charset": "latin-1"
}
```

### Puma configuration

Puma reads its configuration from the `config/puma.rb` file. See [the puma documentation](https://GitHub.com/puma/puma/blob/master/README.md) for more information.

You can override this configuration with [environment variables](#setting-up-environment-variables-on-clever-cloud).
Each of them, when specified, will be be preferred over the setting from `config/puma.rb`. 

* `CC_PUMA_WORKERS` overrides the number of workers (e.g. `CC_PUMA_WORKERS=2`)
* `CC_PUMA_THREADS` overrides the number of threads per worker, can be a raw number or a range (e.g. `CC_PUMA_THREADS=6` or `CC_PUMA_THREADS=4:8`)

If they are not defined in the environment nor in `config/puma.rb` we will setup the values depending on the size of the scaler your application is running on.
We also fill the `WEB_CONCURRENCY` and `RAILS_MAX_THREADS` environment variable if they are not present as they may be used by rails' puma configuration.

## Overridding rackup application server

You can override the puma default server by setting an [environment variable](#setting-up-environment-variables-on-clever-cloud) `CC_RACKUP_SERVER=yourserver`. We do not recommend you do it.
